<!DOCTYPE html>

<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <!--link rel="icon" href="http://v3.bootcss.com/favicon.ico" -->

    <title>Python Django Study</title>

    <!-- Bootstrap core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/static/css/navbar-fixed-top.css" rel="stylesheet">
    <link href="/static/css/customize.css" rel="stylesheet">
	<link href="/static/css/common.css"    rel="stylesheet">

  </head>

 <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">博客</a>
        </div>
		
        <div id="navbar" class="navbar-collapse collapse">
			 <ul class="nav navbar-nav"> 
				<li class="active"><a href="#">全部</a></li>
				<li class="active"><a href="#">1024区</a></li>
				<li class="active"><a href="#">Docker</a></li>
				<li class="active"><a href="#">云计算</a></li>
			 </ul>

          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle  pull-right" data-toggle="dropdown">
			    <li class="active hide"><a href="/register">注&nbsp;册</a></li>
				<li class="active "><a href="/login">
                {% if username %}
				   {{username}}
				{%else%} 
        		     登录
				{%endif%}
				<!-- 
               <span class="caret "></span></a>
					<ul class="dropdown-menu" role="menu">
						<li><a href="/logout/">退出</a></li>
					</ul>
					</a></li> 
					
				<li class="active"><a href="/logout/">退出</a></li>-->
            </li>
          </ul>
        </div>
      </div>
    </nav>

 <div class="class="main-content-band">
   <div class="main-content"> 
        <div class="content-L"> 
		<div class="news-content"> 
		
			{% block page-content %}
				 {% for bbs in bbs_list  %}
					<div class='part1'><a href="{{bbs.url}}" target="_blank" >{{bbs.title}}</a><br></div>					   
					<div class='part2'>{{bbs.summary}}</div> 
					<div class='part3'>
						<a href="#" onclick='Favor(this,{{bbs.id}});'>赞 {{bbs.favor_count}}</a>
						<a href="#" id='replay' onclick='Reply(this,{{bbs.id}});'>评论 {{bbs.reply_count}} </a>
						<span>{{bbs.create_date|date:'Y-m-d H:i:s'}}</span></div> 	
					<div class='part4 hide' has_input='0' >
						<div class='replys'></div>
						<div class='input'><labal>请输入评论内容:</label>
							<textarea></textarea>
							<input type='button' value='提交' onclick='Submitreply(this,{{bbs.id}});'/>
						</div>
					</div>
					<br>	
				{% endfor %}
			{% endblock %}</div>
		</div>
		<div class='content-R'>
			<div class='title'>公共聊天</div>
			<div id='chatpool' content='content'></div>
			<div class='bottom clearfix'>
				<div class='left msg'> <textarea id='message' class='text'> </textarea></div>
				<div class='left submit'> <input type='button' class='btn' onclick='SendMsg();' value='发送'/> </div>
			</div>
		</div>
	</div>
<!--
	<div class='footer-band'>
		<div class='foot-nav'>
		<p class="footer">Copyright © 2017-3-18 GuoLikai 个人博客<br><br>技术支持:glk73748196@sina.com</p>
	</div>-->
</div>
<div class="footer">
<p >Copyright © 2017-3-18 GuoLikai 个人博客<br><br>技术支持:glk73748196@sina.com</p>
</div>

	<script src="/static/js/jquery-2.1.1.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
	<script type='text/javascript'>
		function Favor(doc,id){
			//后台数据点赞+1;
			$.ajax({
				url:'/addfavor/',
				data:{nid:id},
				type:'POST',
				success:function(callback){
					var obj = jQuery.parseJSON(callback);
					if(obj.status==1){
					var temp = '赞'+obj.data
						$(doc).text(temp);
					}else{
						alert(obj.message);}
				}
			});
		}
		
		function Reply(doc,id){
			//后台评论数据获取;
			$.ajax({
				url:'/getreply/',
				data:{nid:id},
				type:'POST',
				success:function(callback){
					//console.log(callback);
					var obj = jQuery.parseJSON(callback);
					//temp = console.log(obj[1].content);
					//console.log(obj)
					$(doc).parent().next().find('.replys').empty();
					$.each(obj,function(k,v){
						//$(doc).parent().next().first().text('0000000');
						//console.log(v.content)
						temp = "<div>"+v.user__username+":"+v.content+"  ---@"+v.create_date+"</div>";
						$(doc).parent().next().find('.replys').append(temp);	
					});
				}
			});
			$(doc).parent().next().toggleClass('hide');
		}
		
		function Submitreply(doc,id){
			//提交评论数据
			$.ajax({
				url:'/submitreply/',
				data:{nid:id,data:$(doc).prev().val()},
				type:'POST',
				success:function(callback){	
					//console.log(callback)
					$(doc).prev().val('')
					var obj = jQuery.parseJSON(callback);
					if(obj.status==1){
					//把数据append到评论列表
						var temp = "<div>"+obj.data.user__username+":"+obj.data.content+"  ---@"+obj.data.create_date+"</div>";
						var temp1 = '评论' + obj.data.count
						$(doc).parent().parent().prev().children('replay').text(temp1);
						$(doc).parent().prev().append(temp);
					}else{
						alert('操作失败.');}
				}
			});	
		}
		
		function SendMsg(){
			//公共聊天发送消息
			//val value=$('#message').val();
			
			$.ajax({
				url:'/submitchat/',
				data:{data:$('#message').val()},
				type:'POST',
				success:function(callback){
					console.log(callback)
					var obj = jQuery.parseJSON(callback);
					if(obj.status==1){
						var name=obj.data.username
						var now=obj.data.create_date
						var template = "<div><div>"+name+"---@"+now+"</div><div>"+$('#message').val()+"</div></div>";
						$('#chatpool').append(template);
						$('#message').val('');
						window.last_id = obj.data.id;
						//console.log(window.last_id)
						//公共聊天右侧滚动条回滚
						var height = document.getElementById('chatpool');
						$('#chatpool').scrollTop(height)
					}else{
						alert('操作请求失败.');}
				}
			});	
			//$('#message').val('')
		}
		
		setInterval('going()',5000);
		window.is_first = true
		function going(){
			if(is_first){
				$.ajax({
					url:'/getchat/',
					type:'POST',
					success:function(callback){
						//console.log(callback);
						var obj = jQuery.parseJSON(callback);
						window.last_id = obj[0].id
						obj = obj.reverse();
						$.each(obj,function(k,v){
							var name=v.user__username
							var now=v.create_date
							var value=v.content
							var template = "<div><div>"+name+"---@"+now+"</div><div>"+value+"</div></div>";
							$('#chatpool').append(template);	
						});
						//公共聊天右侧滚动条回滚
						window.is_first = false
						var height = document.getElementById('chatpool')
						$('#chatpool').scrollTop(height)
					}
				});
			}else{
				$.ajax({
					url:'/getchat2/',
					data:{'last_id':window.last_id},
					type:'POST',
					success:function(callback){
						//console.log(callback);
						var obj = jQuery.parseJSON(callback);
						//console.log(obj.length)
						if(obj.length>0){
							window.last_id = obj[obj.length-1].id
							$.each(obj,function(k,v){
								var name=v.user__username
								var now=v.create_date
								var value=v.content
								var template = "<div><div>"+name+"---@"+now+"</div><div>"+value+"</div></div>";
								$('#chatpool').append(template);
							});
						}	
						var height = document.getElementById('chatpool')
						$('#chatpool').scrollTop(height)
					}
				});
			}
		}
		
	</script>
</body></html>

